<?php
/**
 * SpeedAdmin
 * ============================================================================
 * 版权所有 2018-2027 SpeedAdmin，并保留所有权利。
 * 网站地址: https://www.SpeedAdmin.cn
 * ----------------------------------------------------------------------------
 * 采用最新Thinkphp6实现
 * ============================================================================
 * Author: yuege
 * Date: 2019/8/2
 */
namespace app\backend\controller;
use app\backend\service\AuthService;
use app\common\controller\Backend;
use Exception;
use speed\helper\SignHelper;
use think\exception\ValidateException;
use think\facade\Request;

class Login extends Backend {

    protected $layout='';
    public function index(){
        if (!Request::post()) {
            $admin= session('admin');
            $admin_sign= session('admin.token') == SignHelper::authSign($admin) ? $admin['id'] : 0;
            // 签名验证是否存在
            if ($admin && $admin_sign) {
                 redirect('index/index');
            }
            $view = ['loginbg'=> "/static/backend/images/admin-bg.jpg"];
            return view('',$view);

        } else {
            $data  = $this->request->post() ;
            $username = $this->request->post('username', '', 'speed\helper\StringHelper::filterWords');
            $password = $this->request->post('password', '', 'speed\helper\StringHelper::filterWords');
            $rememberMe = $this->request->post('rememberMe');
            $rule = [
                "captcha|验证码" => 'require|captcha',
            ];
            $this->validate($data, $rule);
            // 用户信息验证
            try {
                $auth = new AuthService();
                $auth->checkLogin($username, $password, $rememberMe);
            } catch (Exception $e) {
                 $this->error(lang('Login Failed')."：{$e->getMessage()}",'',['token'=>$this->token()]);
            }
            $this->success(lang('Login Success').'...',url('index/index'));
        }
    }
    public function verify()
    {
        return parent::verify(); // TODO: Change the autogenerated stub
    }

}